<!DOCTYPE html>
<html><head><meta charset="utf-8" /><meta content="IE=edge;chrome=1" http-equiv="X-UA-Compatible" /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><link href="/images/favicon.ico" rel="icon" type="image/ico" /><link href="http://blog.glebm.com/feed.xml" rel="alternate" title="Gleb's Notes Feed" type="application/atom+xml" /><title>Save Redis memory with large list packing on Gleb's Notes</title><link href="/stylesheets/application.css?1393510097" media="screen" rel="stylesheet" type="text/css" /><link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet" /><script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" type="text/javascript"></script><script src="/javascripts/application.js?1393492259" type="text/javascript"></script>
</head><body><script type="text/javascript">      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-43451052-1', 'glebm.com');
      ga('send', 'pageview');
</script><header class="navbar navbar-inverse"><div class="container"><div class="navbar-header"><button class="navbar-toggle" data-target=".bs-navbar-collapse" data-toggle="collapse" type="button"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><div class="navbar-brand"><a href="/">Gleb's Notes</a></div></div><nav class="collapse navbar-collapse bs-navbar-collapse nav-default"><ul class="nav navbar-nav"><li><a href="/">Index</a></li></ul></nav></div></header><div class="container"><div class="row"><div class="col-md-9 col-lg-9"><div class=" " id="main" role="main"><div class="article-layout"><article class="blog-article"><div class="article-date"><span class='date'> <span class='day'>31</span> <span class='month'>Aug</span> <span class='year'> 2013 </span> </span></div><h1><a href="http://blog.glebm.com/2013/08/31/redis-compressed-lists.html">Save Redis memory with large list packing</a></h1><div class="article-body"><p>Redis is great for storing certain types of data that do not do well in a relational database.
It is great for storing caches and statistics too.
However, the storage capacity of redis is capped by RAM size, so care is required when storing large amounts of data in it.</p>

<p>I will show you a trick to reduce memory usage and improve the speed of the redis <em>list</em> type for storing series-type data (e.g. time series).
Redis <a href="https://github.com/antirez/redis/blob/unstable/src/ziplist.c">packs</a> small lists of ints, reducing their memory usage by 10-40%.
The exact list size threshold at which redis stops compressing is defined by the <code>list-max-ziplist-entries</code> setting and defaults to 512.</p>

<p>Here is the trick: we will transparently partition a list into many small lists of <code>list-max-ziplist-entries</code> size.
By storing lists under the threshold, we take advantage of redis' ability to pack them.</p>

<p></p>

<p>Here is a memory usage benchmark with random int values between 0 and 10:</p>

<p><img class="img-responsive" alt="" width="1200" height="600" src="http://blog.glebm.com/images/2013-08-31-redis-compressed-lists/bm-512.png?1393591698" /></p>

<p>To benchmark access speed let's try some random accesses on a large list:</p>

<pre class="highlight shell">bm_speed: 3,000,000 keys, 100 random range reads
                           user     system      total        real
regular                0.380000   0.040000   0.420000 <span class="o">(</span>  0.686875<span class="o">)</span>
partitioned            0.390000   0.060000   0.450000 <span class="o">(</span>  0.482544<span class="o">)</span>
</pre>
<p>Even despite Ruby overhead we still have both wall-clock time and memory savings.
A regular redis list is a linked list, so getting ranges out of it is slow.
However, when we use this technique the list is partitioned, and it only takes <code>O(1)</code> to get to the correct partition.
As you increase <code>list-max-ziplist-entries</code>, memory savings increase and range queries get slower.</p>

<p>I published a <a href="https://github.com/glebm/redis_stats/blob/master/lib/redis_stats/int_series.rb">Ruby implementation</a> of this approach for int and time series.</p>

<p>Are you doing something similar? I am curious to hear other approaches.</p>

<p><em>Thanks <a href="https://twitter.com/ddtrejo">@ddtrejo</a> for your edits and suggestions!</em></p>

<h4 id="notes">Notes</h4>

<ul>
  <li>Packing efficiency depends on the data. Benchmark with your real data.</li>
  <li>You can implement a similar trick for hashes and sets, redis will compress them based on the respective <code>-ziplist-entries</code> values.</li>
  <li>Tested on redis 2.6.14, installed via homebrew on OS X 10.8.3.</li>
</ul>

<h4 id="see-also">See also</h4>

<ul>
  <li><a href="https://news.ycombinator.com/item?id=6307769">Discussion on Hacker News</a>.</li>
  <li>Instagram dev blog post on <a href="http://instagram-engineering.tumblr.com/post/12202313862/storing-hundreds-of-millions-of-simple-key-value-pairs">storing key-value pairs using partitioned hashes</a>.</li>
  <li><a href="http://www.manning.com/carlson/">Redis in Action</a> book by <a href="https://twitter.com/dr_josiah">@dr_josiah</a>.</li>
</ul>

</div><div class="article-footer"><div class="permalink"><label class="form-label text-muted" for="permalink-input">permalink </label><input class="input-sm form-control select-text-on-click" id="permalink-input" type="text" value="http://blog.glebm.com/2013/08/31/redis-compressed-lists.html" /></div><div class="twtr-share"><a class="twitter-share-button" data-lang="en" data-size="large" data-url="http://blog.glebm.com/2013/08/31/redis-compressed-lists.html" data-via="glebm" href="https://twitter.com/share">Tweet</a></div><div class="suggest-edit"><a class="btn btn-default btn-sm" href="https://github.com/glebm/blog-glebm-com/blob/master/source/2013-08-31-redis-compressed-lists.html.markdown.erb"><i class='glyphicon glyphicon-edit'></i> Suggest edit</a></div></div></article><div class="comments">    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_shortname = "blog-glebm";
var disqus_identifier = "redis-compressed-lists";
var disqus_title = "Save Redis memory with large list packing";
var disqus_url = "http://blog.glebm.com/2013/08/31/redis-compressed-lists.html";
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div></div></div></div><div class="col-md-3"><aside class="sidebar"><div class="person-img"><img alt="" width="400" height="400" src='http://blog.glebm.com/images/author.jpg?1393591698' /></div><p><abbr title="Gleb Mazovetskiy">@glebm</abbr></p><p><ul class="nav nav-pills nav-justified"><li><a href="https://twitter.com/glebm" rel="me"><i class='fa fa-twitter'></i> Twitter</a></li><li><a href="https://github.com/glebm" rel="me"><i class='fa fa-github'></i> Github</a></li></ul></p><hr /><ul class="nav nav-pills nav-stacked"><li><a href="http://blog.glebm.com/2014/02/27/i18n-made-easier-with-static-analysis.html">Internationalization made easier with static analysis</a></li><li class="active"><a href="http://blog.glebm.com/2013/08/31/redis-compressed-lists.html">Save Redis memory with large list packing</a></li><li><a href="http://blog.glebm.com/2013/08/28/inline-css-fonts.html">Inline CSS web fonts</a></li><li><a href="http://blog.glebm.com/2013/08/23/screenshots-in-git.html">Store screenshots of your web app in Git</a></li></ul><hr /><ul class="nav nav-stacked text-left nav-pills"><li><a href="http://blog.glebm.com/feed.xml"><i class='fa fa-rss fa-fw'></i> Atom Feed</a></li><li><a href="https://github.com/glebm/blog-glebm-com"><i class='fa fa-code-fork fa-fw'></i> This blog on Github</a></li></ul></aside></div></div></div><script type="text/javascript">!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script></script></body></html>